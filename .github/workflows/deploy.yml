name: Build and Deploy WordPress Plugin

on:
  workflow_dispatch: # Позволява ръчно стартиране от GitHub UI
  push:
    tags:
      - "v*" # Стартира се при всеки таг от вида v1.0.0

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      PLUGIN_SLUG: bizzio-sync-for-woocommerce
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        continue-on-error: false
        with:
          # Винаги checkout от main branch, независимо от тага
          fetch-depth: 0
       
      - name: Validate plugin structure
        continue-on-error: false
        run: |
          echo "=== Validating Plugin Structure ==="
          
          if [ ! -f "bizzio-sync-for-woocommerce/bizzio-sync-for-woocommerce.php" ]; then
            echo "❌ Main plugin file not found!"
            exit 1
          fi
          
          if [ ! -f "bizzio-sync-for-woocommerce/readme.txt" ]; then
            echo "❌ readme.txt not found!"
            exit 1
          fi
          
          echo "✅ Plugin structure valid"
       
      - name: Extract version from files
        id: version
        continue-on-error: false
        run: |
          readme_version=$(grep -i "Stable tag" bizzio-sync-for-woocommerce/readme.txt | awk '{print $3}' | tr -d '\r\n ')
          plugin_version=$(grep -i "Version:" bizzio-sync-for-woocommerce/bizzio-sync-for-woocommerce.php | head -n 1 | awk '{print $3}' | tr -d '\r\n ')
          
          echo "readme_version=$readme_version" >> $GITHUB_OUTPUT
          echo "plugin_version=$plugin_version" >> $GITHUB_OUTPUT
          
          echo "Version from readme.txt: $readme_version"
          echo "Version from plugin file: $plugin_version"
          
          if [ "$readme_version" != "$plugin_version" ]; then
            echo "❌ Version mismatch detected!"
            exit 1
          fi
          
          echo "✅ Versions match: $readme_version"
          echo "✅ Versions match: $readme_version"
       
      - name: Build plugin ZIP
        continue-on-error: false
        run: |
          mkdir -p build
          
          echo "=== Build Information ==="
          echo "Git Branch: $(git branch --show-current)"
          echo "Git Commit: $(git rev-parse HEAD)"
          echo "Git Tag: $(git describe --tags --exact-match 2>/dev/null || echo 'No tag')"
          echo "Plugin Version: ${{ steps.version.outputs.readme_version }}"
          echo "========================="
          
          # Създаваме ZIP с папката bizzio-sync-for-woocommerce
          cd bizzio-sync-for-woocommerce
          zip -r ../build/${{ env.PLUGIN_SLUG }}.zip . -x \
            ".git*" \
            ".DS_Store" \
            "*.log" \
            "node_modules/*" \
            "tests/*"
          cd ..
          
          # Проверка дали ZIP е създаден успешно
          if [ ! -f "build/${{ env.PLUGIN_SLUG }}.zip" ]; then
            echo "❌ Failed to create ZIP file!"
            exit 1
          fi
          
          # Показваме структурата
          echo "=== ZIP Archive Contents (first 30 files) ==="
          unzip -l build/${{ env.PLUGIN_SLUG }}.zip | head -30
          echo ""
          echo "=== Build Directory ==="
          ls -lh build/
          echo "✅ ZIP created successfully"
       
      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        continue-on-error: false
        with:
          name: ${{ env.PLUGIN_SLUG }}-${{ steps.version.outputs.readme_version }}
          path: build/${{ env.PLUGIN_SLUG }}.zip
          retention-days: 90
       
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/v')
        continue-on-error: true
        with:
          files: build/${{ env.PLUGIN_SLUG }}.zip
          name: Release ${{ github.ref_name }}
          body: |
            ## WordPress Plugin Release ${{ steps.version.outputs.readme_version }}
            
            Built from `main` branch at commit `${{ github.sha }}`
            
            ### Download
            - [bizzio-sync-for-woocommerce.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/bizzio-sync-for-woocommerce.zip)
            
            ### Installation
            1. Download the ZIP file above
            2. Go to WordPress Admin → Plugins → Add New → Upload Plugin
            3. Upload the ZIP file and activate
            
            ### Changelog
            See [readme.txt](https://github.com/${{ github.repository }}/blob/main/bizzio-sync-for-woocommerce/readme.txt#L1) for full changelog.
          draft: false
          prerelease: false
          make_latest: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
       
      - name: Summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Plugin:** ${{ env.PLUGIN_SLUG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.readme_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "build/${{ env.PLUGIN_SLUG }}.zip" ]; then
            size=$(ls -lh build/${{ env.PLUGIN_SLUG }}.zip | awk '{print $5}')
            echo "- **ZIP Size:** $size" >> $GITHUB_STEP_SUMMARY
            echo "✅ **Status:** Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** Build failed" >> $GITHUB_STEP_SUMMARY
          fi
      #   uses: 10up/action-wordpress-plugin-deploy@v2
      #   with:
      #     plugin_slug: ${{ env.PLUGIN_SLUG }}
      #     svn_username: ${{ secrets.WPORG_USERNAME }}
      #     svn_password: ${{ secrets.WPORG_PASSWORD }}