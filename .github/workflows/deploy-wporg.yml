name: Deploy to WordPress.org

on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Dry run (skip actual SVN deployment)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  deploy-wporg:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        continue-on-error: false
        with:
          fetch-depth: 0
      
      - name: Validate plugin files exist
        continue-on-error: false
        run: |
          echo "=== Validating Plugin Structure ==="
          
          if [ ! -f "bizzio-sync-for-woocommerce/bizzio-sync-for-woocommerce.php" ]; then
            echo "âŒ Main plugin file not found!"
            exit 1
          fi
          
          if [ ! -f "bizzio-sync-for-woocommerce/readme.txt" ]; then
            echo "âŒ readme.txt not found!"
            exit 1
          fi
          
          echo "âœ… All required files present"

      - name: Extract and validate versions
        id: versions
        continue-on-error: false
        run: |
          if [ "${{ steps.readme.outputs.readme_version }}" != "${{ steps.plugin.outputs.plugin_version }}" ]; then
            echo "âŒ Version mismatch! readme.txt = ${{ steps.readme.outputs.readme_version }}, bizzio-sync-for-woocommerce.php = ${{ steps.plugin.outputs.plugin_version }}"
            exit 1
          fi
          
          echo "âœ… Versions match: $readme_version"

      - name: Deploy Plugin Code
        uses: 10up/action-wordpress-plugin-deploy@stable
        with:
          generate-zip: false
        env:
          SLUG: bizzio-sync-for-woocommerce
          BUILD_DIR: bizzio-sync-for-woocommerce
          ASSETS_DIR: .wordpress-org
          VERSION: ${{ steps.versions.outputs.readme_version }}
          SVN_USERNAME: ${{ secrets.WP_SVN_USERNAME }}
          SVN_PASSWORD: ${{ secrets.WP_SVN_PASSWORD }}
      
      - name: Dry run summary
        if: inputs.dry-run == 'true'
        run: |
          echo "ðŸ” DRY RUN MODE - No deployment performed"
          echo "Version that would be deployed: ${{ steps.versions.outputs.readme_version }}"
          echo "Plugin slug: bizzio-sync-for-woocommerce"
      
      - name: Deployment summary
        if: always()
        run: |
          echo "## WordPress.org Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Plugin Slug:** bizzio-sync-for-woocommerce" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.versions.outputs.readme_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ inputs.dry-run }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry-run }}" == "true" ]; then
            echo "- **Status:** ðŸ” Dry run completed (no actual deployment)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** âœ… Deployed to WordPress.org" >> $GITHUB_STEP_SUMMARY
            echo "- **Plugin URL:** https://wordpress.org/plugins/bizzio-sync-for-woocommerce/" >> $GITHUB_STEP_SUMMARY
          fi
