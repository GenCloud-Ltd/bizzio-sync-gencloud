name: Deploy to WordPress.org (release)

on:
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PLUGIN_DIR: bizzio-sync-for-woocommerce   # папката на плъгина в репото
      SLUG: bizzio-sync-for-woocommerce         # slug в wp.org
      ASSETS_DIR: assets                        # ако нямаш assets, махни реда
      SVN_USERNAME: ${{ secrets.SVN_USERNAME }} # или WP_SVN_USERNAME
      SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }} # или WP_SVN_PASSWORD

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract & validate version
        id: ver
        shell: bash
        run: |
          set -euo pipefail
          READM="$PLUGIN_DIR/readme.txt"
          MAINPHP="$PLUGIN_DIR/bizzio-sync-for-woocommerce.php"  # <-- смени ако е друго

          [[ -f "$READM" ]] || { echo "readme.txt not found at $READM"; exit 1; }
          [[ -f "$MAINPHP" ]] || { echo "Main plugin PHP not found at $MAINPHP"; exit 1; }

          readme_version=$(sed -nE 's/^[[:space:]]*Stable tag:[[:space:]]*([^[:space:]]+).*$/\1/ip' "$READM" | head -n1 | tr -d '[:space:]')
          plugin_version=$(sed -nE 's/^[[:space:]]*(\* )?Version:[[:space:]]*([^[:space:]]+).*$/\2/ip' "$MAINPHP" | head -n1 | tr -d '[:space:]')

          echo "Detected -> readme: ${readme_version:-EMPTY}, plugin: ${plugin_version:-EMPTY}"

          # блокирай trunk/refs/*
          if [[ "$readme_version" == "trunk" || "$readme_version" == refs/* || "$readme_version" == heads/* ]]; then
            echo "❌ Invalid Stable tag ($readme_version). Set a real version like 1.2.3"
            exit 1
          fi

          # (по желание) базова валидация за семантика x.y.z
          if ! [[ "$readme_version" =~ ^[0-9]+(\.[0-9]+){1,2}(-[0-9A-Za-z.-]+)?$ ]]; then
            echo "⚠️ Stable tag doesn't look like a version: $readme_version (continuing, but recommended: 1.2.3)"
          fi

          if [[ -z "${readme_version:-}" || -z "${plugin_version:-}" ]]; then
            echo "Could not detect versions"; exit 1
          fi
          if [[ "$readme_version" != "$plugin_version" ]]; then
            echo "❌ Version mismatch: readme=$readme_version, plugin=$plugin_version"; exit 1
          fi

          echo "version=$readme_version" >> "$GITHUB_OUTPUT"

      # - name: Deploy to wp.org SVN (10up)
      #   id: deploy
      #   uses: 10up/action-wordpress-plugin-deploy@stable
      #   with:
      #     svn-username: ${{ env.SVN_USERNAME }}
      #     svn-password: ${{ env.SVN_PASSWORD }}
      #     slug:        ${{ env.SLUG }}
      #     build-dir:   ${{ env.PLUGIN_DIR }}
      #     assets-dir:  ${{ env.ASSETS_DIR }}
      #     version:     ${{ steps.ver.outputs.version }}  # <-- ключово: да не взема GITHUB_REF
      #     generate-zip: true
      - name: WordPress Plugin Deploy (trunk only)
        uses: 10up/action-wordpress-plugin-deploy@stable
        with:
          svn-username: ${{ secrets.SVN_USERNAME }}
          svn-password: ${{ secrets.SVN_PASSWORD }}
          slug: bizzio-sync-for-woocommerce
          build-dir: bizzio-sync-for-woocommerce
          skip-tag: true


      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SLUG }}-${{ steps.ver.outputs.version }}.zip
          path: ${{ steps.deploy.outputs.zip-path }}
